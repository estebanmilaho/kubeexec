name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    environment: production

    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"
      - uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
      - name: Update krew manifest in repo
        env:
          TAG: ${{ github.ref_name }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ ! -f dist/krew/xc.yaml ]; then
            echo "dist/krew/xc.yaml not found"
            exit 1
          fi

          tmp_manifest="$(mktemp)"
          cp dist/krew/xc.yaml "${tmp_manifest}"

          BRANCH="automation/krew-manifest-${TAG}"
          git fetch origin "${DEFAULT_BRANCH}"
          git checkout -B "${DEFAULT_BRANCH}" "origin/${DEFAULT_BRANCH}"
          git checkout -b "${BRANCH}"

          mkdir -p .krew
          cp "${tmp_manifest}" .krew/xc.yaml

          if git diff --quiet -- .krew/xc.yaml; then
            echo "krew manifest unchanged"
            exit 0
          fi

          git add .krew/xc.yaml
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update krew manifest for ${TAG}"
          git push -u origin "${BRANCH}"

          gh pr create \
            --base "${DEFAULT_BRANCH}" \
            --head "${BRANCH}" \
            --title "Update krew manifest for ${TAG}" \
            --body "Automated update of .krew/xc.yaml for ${TAG}."
